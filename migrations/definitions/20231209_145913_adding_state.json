{"schemas":"--- original\n+++ modified\n@@ -19,13 +19,11 @@\n DEFINE FIELD hw_version ON device TYPE option<string>;\n DEFINE TABLE entity SCHEMAFULL;\n\n-DEFINE FIELD state ON entity TYPE string;\n DEFINE FIELD enabled ON entity TYPE bool DEFAULT true;\n DEFINE FIELD available ON entity TYPE bool DEFAULT true;\n DEFINE FIELD class ON entity TYPE string;\n DEFINE FIELD attributes ON entity TYPE option<object>;\n-\n--- DEFINE EVENT state_changed ON TABLE entity WHEN $before.state != $after.state THEN ();\n+DEFINE FIELD state_id ON entity TYPE option<record<state>>;\n DEFINE TABLE script_migration SCHEMAFULL\n     PERMISSIONS\n         FOR select FULL\n@@ -33,6 +31,21 @@\n\n DEFINE FIELD script_name ON script_migration TYPE string;\n DEFINE FIELD executed_at ON script_migration TYPE datetime DEFAULT time::now();\n+DEFINE TABLE state SCHEMAFULL;\n+\n+DEFINE FIELD state ON state TYPE string ASSERT $value != null;\n+DEFINE FIELD attributes ON state FLEXIBLE TYPE object DEFAULT {};\n+DEFINE FIELD updated_at ON state TYPE datetime DEFAULT time::now();\n+DEFINE FIELD entity_id ON state TYPE record<entity>;\n+\n+-- Set last state to the entity\n+DEFINE EVENT state_created ON TABLE state WHEN $event = \"CREATE\" THEN (\n+    UPDATE $after.entity_id SET state_id = $after.id\n+);\n+\n+DEFINE EVENT attributes_changed ON TABLE state WHEN $before.attributes != $after.attributes THEN (\n+    UPDATE $after.id SET updated_at = time::now()\n+);\n DEFINE TABLE updates SCHEMAFULL;\n\n DEFINE FIELD in ON TABLE updates TYPE record<device> ASSERT $value != NONE;\n","events":null}